# Anycubic Kobra 2 Neo - Zoptymalizowana Konfiguracja
# Wersja 2.1.1 - Adaptacyjny Mesh i Pełne Makra
# Board: Trigorilla 4.0.1

[include mainsail.cfg]
[include makro.cfg]
[include pause_resume.cfg]
[include moonraker_obico_macros.cfg]
#[include adxl.cfg]

# =============================================================================
# PODSTAWOWA KONFIGURACJA MCU
# =============================================================================
[mcu]
serial: /dev/serial/by-id/usb-1a86_USB_Serial-if00-port0
baud: 115200
restart_method: command

[printer]
kinematics: cartesian
max_velocity: 250
max_accel: 5000            # Zoptymalizowane dla jakości
minimum_cruise_ratio: 0.5  # Nowoczesny zamiennik max_accel_to_decel
square_corner_velocity: 5.0
max_z_velocity: 8
max_z_accel: 800

# =============================================================================
# INPUT SHAPER
# =============================================================================
[input_shaper]
shaper_freq_x: 54.8
shaper_type_x: ei
shaper_freq_y: 34.0
shaper_type_y: mzv

# =============================================================================
# OSIE (STEPPERS)
# =============================================================================
[stepper_x]
step_pin: PA12
dir_pin: PA11
enable_pin: !PA15
microsteps: 16
rotation_distance: 40
endstop_pin: ^!PB11
position_endstop: -10
position_min: -14
position_max: 215
homing_speed: 100
homing_retract_dist: 5

[stepper_y]
step_pin: PA9
dir_pin: !PA8
enable_pin: !PA15
microsteps: 16
rotation_distance: 40
endstop_pin: ^!PC13
position_endstop: -2
position_min: -3
position_max: 230
homing_speed: 100
homing_retract_dist: 5

[stepper_z]
step_pin: PB0
dir_pin: !PB1
enable_pin: !PA15
microsteps: 16
rotation_distance: 8
endstop_pin: probe:z_virtual_endstop
position_min: -2
position_max: 200
homing_speed: 15
second_homing_speed: 2
homing_retract_dist: 3

# =============================================================================
# EXTRUDER & BED
# =============================================================================
[extruder]
step_pin: PB15
dir_pin: PB14
enable_pin: !PA15
microsteps: 16
max_extrude_cross_section: 5.0
max_extrude_only_distance: 200
max_extrude_only_velocity: 80
max_extrude_only_accel: 5000
rotation_distance: 7.084
nozzle_diameter: 0.400
filament_diameter: 1.750
heater_pin: PB8
sensor_type: ATC Semitec 104GT-2
sensor_pin: PC3
min_extrude_temp: 170
min_temp: 0
max_temp: 280
pressure_advance: 0.06
pressure_advance_smooth_time: 0.040

[heater_bed]
heater_pin: PB9
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PC1
min_temp: 0
max_temp: 120

# =============================================================================
# PROBE & MESH
# =============================================================================
[probe]
pin: PA1
x_offset: 24.0
y_offset: 13.35
samples: 3
samples_result: average
sample_retract_dist: 2
speed: 10
lift_speed: 8
samples_tolerance: 0.05
samples_tolerance_retries: 5

[bed_mesh]
speed: 150
horizontal_move_z: 3
mesh_min: 14, 11
mesh_max: 210, 215
probe_count: 9, 9        # Wysoka dokładność
mesh_pps: 4, 4
algorithm: bicubic
bicubic_tension: 0.2
fade_start: 1.0
fade_end: 10.0
fade_target: 0
adaptive_margin: 5       # Margines dla siatki adaptacyjnej

[safe_z_home]
home_xy_position: 110, 110
speed: 100
z_hop: 10
z_hop_speed: 15
move_to_previous: False

[screws_tilt_adjust]
screw1: -10, -2
screw1_name: Przedni lewy
screw2: 186, -2
screw2_name: Przedni prawy
screw3: 186, 202
screw3_name: Tylny prawy
screw4: -10, 202
screw4_name: Tylny lewy
horizontal_move_z: 5
speed: 200
screw_thread: CCW-M4

# =============================================================================
# WENTYLATORY & DODATKI
# =============================================================================
[controller_fan controller_fan]
pin: PB12
stepper: stepper_x, stepper_y, stepper_z, extruder
idle_timeout: 60

[heater_fan extruder_fan]
pin: PB13
heater: extruder
heater_temp: 50.0
fan_speed: 1.0

[fan]
pin: PB5
cycle_time: 0.0001
kick_start_time: 0.5

[output_pin enable_pin]
pin: PB6
value: 1
shutdown_value: 1

[exclude_object]

[gcode_arcs]
resolution: 0.1
[gcode_macro _CLIENT_VARIABLE]
variable_use_custom_pos    : True
variable_custom_park_x     : 110.0
variable_custom_park_y     : 10.0
variable_custom_park_dz    : 10.0
variable_retract           : 1.0
variable_cancel_retract    : 5.0
variable_speed_retract     : 35.0
variable_unretract         : 1.0
variable_speed_move        : 150.0
variable_park_at_cancel    : True
gcode:

[virtual_sdcard]
path: ~/printer_data/gcodes
on_error_gcode: CANCEL_PRINT

[display_status]

[pause_resume]

[respond]

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [probe]
#*# z_offset = 1.656
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 18.294
#*# pid_ki = 0.726
#*# pid_kd = 115.251
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 59.972
#*# pid_ki = 0.943
#*# pid_kd = 953.553
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  0.198333, 0.193333, 0.244167, 0.338333, 0.373333, 0.445000, 0.550000, 0.632500, 0.752500
#*# 	  0.105000, 0.105000, 0.148333, 0.253333, 0.293333, 0.351667, 0.458333, 0.545000, 0.660833
#*# 	  0.026667, 0.034167, 0.096667, 0.206667, 0.250000, 0.315000, 0.419167, 0.519167, 0.638333
#*# 	  -0.010833, -0.001667, 0.050000, 0.153333, 0.186667, 0.253333, 0.355833, 0.442500, 0.544167
#*# 	  -0.090833, -0.104167, -0.056667, 0.039167, 0.065000, 0.113333, 0.228333, 0.311667, 0.353333
#*# 	  -0.118333, -0.151667, -0.131667, -0.035000, -0.005833, -0.005000, 0.071667, 0.121667, 0.136667
#*# 	  -0.208333, -0.261667, -0.260833, -0.184167, -0.157500, -0.173333, -0.140833, -0.118333, -0.091667
#*# 	  -0.332500, -0.399167, -0.413333, -0.371667, -0.377500, -0.377500, -0.338333, -0.342500, -0.346667
#*# 	  -0.485000, -0.550833, -0.579167, -0.537500, -0.544167, -0.538333, -0.506667, -0.506667, -0.510833
#*# x_count = 9
#*# y_count = 9
#*# mesh_x_pps = 4
#*# mesh_y_pps = 4
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 14.0
#*# max_x = 210.0
#*# min_y = 11.0
#*# max_y = 215.0
