# -*- coding: utf-8 -*-
# =============================================================================
# MAKRA POMOCNICZE - OBSŁUGA FILAMENTU I SERWIS
# =============================================================================
# Zawartość:
#   - Ładowanie/wyładowanie filamentu (z walidacją temperatury)
#   - Suszenie filamentu (bezpieczna wersja)
# 
# UWAGA: Te makra wyłączają silniki (M84) - przed drukiem wykonaj G28!
# =============================================================================

# =============================================================================
# ŁADOWANIE FILAMENTU (Load Filament)
# =============================================================================
[gcode_macro LOAD_FILAMENT]
description: Ładuje filament do hotend z automatyczną walidacją temperatury
gcode:
  # --- WALIDACJA TEMPERATURY ---
  # Sprawdzamy czy dysza jest wystarczająco gorąca do ekstruzji
  {% if printer.extruder.temperature < printer.configfile.settings.extruder.min_extrude_temp %}
    RESPOND MSG="BŁĄD: Dysza za zimna do ekstruzji!"
    RESPOND MSG="Aktualna: {printer.extruder.temperature}°C | Wymagana: {printer.configfile.settings.extruder.min_extrude_temp}°C"
    RESPOND MSG="Nagrzej dyszę komendą: M109 S200 (lub wyższą temperaturę)"
    {action_raise_error("Cold extrusion prevented - temperatura za niska")}
  {% endif %}
  
  # --- PRZYGOTOWANIE ---
  M117 Ładowanie filamentu...
  M83  # Ekstruder w trybie względnym (E commands jako relatywne)
  
  # --- SEKWENCJA ŁADOWANIA ---
  # KROK 1: Wstępne załadowanie (wolno, aby filament wszedł w gear)
  RESPOND MSG="[1/2] Ładowanie główne (30mm)..."
  G1 E30 F300  # 30mm przy 300 mm/min (5 mm/s) - wolno dla pewności
  
  # KROK 2: Priming (czyszczenie dyszy)
  RESPOND MSG="[2/2] Priming dyszy (15mm)..."
  G1 E15 F150  # 15mm przy 150 mm/min (2.5 mm/s) - bardzo wolno
  
  # --- ZAKOŃCZENIE ---
  M82  # Powrót do trybu absolutnego dla ekstruderu
  M117 Filament załadowany
  RESPOND MSG="Filament załadowany. Sprawdź czy wychodzi równomiernie z dyszy."

# =============================================================================
# WYŁADOWANIE FILAMENTU (Unload Filament)
# =============================================================================
[gcode_macro UNLOAD_FILAMENT]
description: Wyładowuje filament z hotend (bezpieczna sekwencja)
gcode:
  # --- WALIDACJA TEMPERATURY ---
  {% if printer.extruder.temperature < printer.configfile.settings.extruder.min_extrude_temp %}
    RESPOND MSG="BŁĄD: Dysza za zimna do ekstruzji!"
    RESPOND MSG="Aktualna: {printer.extruder.temperature}°C | Wymagana: {printer.configfile.settings.extruder.min_extrude_temp}°C"
    {action_raise_error("Cold extrusion prevented")}
  {% endif %}
  
  # --- PRZYGOTOWANIE ---
  M117 Wyładowywanie filamentu...
  M83  # Ekstruder w trybie względnym
  
  # --- RUCH DO POZYCJI SERWISOWEJ ---
  # Bezpieczna pozycja: środek stołu, wysoko
  {% if "xyz" in printer.toolhead.homed_axes %}
    {% set park_x = (printer.toolhead.axis_maximum.x / 2)|float %}
    {% set park_y = (printer.toolhead.axis_minimum.y + 50)|float %}
    {% set park_z = 80.0 %}  # 80mm wysokość (wystarczająco wysoko)

    RESPOND MSG="Ruch do pozycji serwisowej..."
    G1 X{park_x} Y{park_y} Z{park_z} F3000  # Ruch do pozycji (3000 mm/min)
  {% else %}
    RESPOND MSG="UWAGA: Osie nie zbazowane - pomijam ruch do pozycji serwisowej"
  {% endif %}
  
  # --- SEKWENCJA WYŁADOWANIA ---
  # KROK 1: Rozmiękcz końcówkę filamentu (zapobiega blokowaniu)
  RESPOND MSG="[1/4] Rozmięczanie końcówki..."
  G1 E10 F300   # 10mm ekstruzji (rozmiękcza tip)
  
  # KROK 2: Gwałtowne wyciągnięcie z melt zone
  RESPOND MSG="[2/4] Wyciąganie z melt zone..."
  G1 E-10 F3000  # -10mm szybko (3000 mm/min = 50 mm/s)
  
  # KROK 3: Główna retrakcja
  RESPOND MSG="[3/4] Główna retrakcja..."
  G1 E-50 F1800  # -50mm przy 1800 mm/min (30 mm/s)
  
  # KROK 4: Finalna retrakcja (ostatnie mm)
  RESPOND MSG="[4/4] Finalna retrakcja..."
  G1 E-10 F900   # -10mm wolno (900 mm/min = 15 mm/s)
  
  # --- ZAKOŃCZENIE ---
  M82  # Powrót do trybu absolutnego
  M117 Filament wyładowany
  RESPOND MSG="Filament wyładowany. Możesz wyciągnąć go z PTFE."

# =============================================================================
# SUSZENIE FILAMENTU (bezpieczna wersja z delayed_gcode)
# =============================================================================

[gcode_macro DRY_FILAMENT]
description: Suszy filament na stole przez 3 godziny (60°C) - BEZPIECZNA WERSJA
gcode:
  # --- INFORMACJA DLA UŻYTKOWNIKA ---
  RESPOND MSG="=== SUSZENIE FILAMENTU ==="
  RESPOND MSG="Temperatura stołu: 60°C"
  RESPOND MSG="Czas: 3 godziny (10800 sekund)"
  RESPOND MSG="UWAGA: Nie zostawiaj bez nadzoru przez cały czas!"
  RESPOND MSG="Możesz anulować komendą: CANCEL_DRY_FILAMENT"
  
  # --- START SUSZENIA ---
  M117 Suszenie: Start
  SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET=60
  M190 S60  # Czekaj aż stół osiągnie 60°C
  
  # --- URUCHOMIENIE DELAYED GCODE (bezpieczniejsze niż G4) ---
  # Zamiast blokującego G4 P10800000, używamy delayed_gcode
  # To pozwala na PAUSE/CANCEL w trakcie suszenia
  UPDATE_DELAYED_GCODE ID=_DRY_FILAMENT_TIMER DURATION=10800  # 3h = 10800s
  
  RESPOND MSG="Suszenie rozpoczęte. Stół nagrzany do 60°C."

# --- WEWNĘTRZNE MAKRO ZAKOŃCZENIA SUSZENIA ---
[delayed_gcode _DRY_FILAMENT_TIMER]
gcode:
  # Wywołane automatycznie po 3 godzinach
  SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET=0
  M117 Suszenie zakończone
  RESPOND MSG="Suszenie zakończone! Stół wyłączony."

# --- MAKRO ANULOWANIA SUSZENIA ---
[gcode_macro CANCEL_DRY_FILAMENT]
description: Anuluje suszenie filamentu i wyłącza stół
gcode:
  UPDATE_DELAYED_GCODE ID=_DRY_FILAMENT_TIMER DURATION=0  # Wyłącz timer
  SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET=0
  M117 Suszenie anulowane
  RESPOND MSG="Suszenie anulowane przez użytkownika. Stół wyłączony."

# =============================================================================
# UWAGI KOŃCOWE
# =============================================================================
# 
# WAŻNE: Makra LOAD_FILAMENT / UNLOAD_FILAMENT nie wyłączają silników.
# Jeśli osie nie były zbazowane, wykonaj G28 przed drukiem.
#
# BEZPIECZEŃSTWO:
# - Wszystkie makra sprawdzają temperaturę przed ekstruzją
# - DRY_FILAMENT może być anulowane w każdej chwili (CANCEL_DRY_FILAMENT)
# - UNLOAD_FILAMENT przesuwa głowicę do bezpiecznej pozycji
#
# TROUBLESHOOTING:
# - Błąd "cold extrusion prevented" → Nagrzej dyszę do min 170°C
# - Filament się zacina → Sprawdź czy PTFE tube nie jest zagięte
# - Druk nie startuje po LOAD → Wykonaj G28 (bazowanie)
#
# =============================================================================