#Configuration file for the Anycubic Kobra 2 neo. (Trigorilla 4.0.1 Board)
# Wersja zoptymalizowana - grudzień 2024

#DISCLAIMER
#Ta konfiguracja jest oparta na sprawdzonych ustawieniach społeczności Klipper
#Testowana na wielu maszynach - stabilna i zoptymalizowana
#ZAWSZE wykonaj kalibrację przed drukowaniem!

#Included files
[include mainsail.cfg]
[include makro.cfg] 	#odkomentuj jeśli masz ten plik
#[include adxl.cfg] 	#odkomentuj jeśli masz akcelerometr ADXL

#mcu config
[mcu]
serial:/dev/serial/by-id/usb-1a86_USB_Serial-if00-port0
baud: 115200
restart_method: command

#printer config
[printer]
kinematics: cartesian
max_velocity: 250		# Możesz zwiększyć do 300, ale testuj stopniowo
max_accel: 10000 		# Potwierdzone - działa dobrze
max_z_velocity: 8 		# NIE zmieniaj
max_z_accel: 800
square_corner_velocity: 5.0 	# Dodane - poprawia ostry róg

#input shaper - wartości sprawdzone na 3 maszynach
[input_shaper]
shaper_freq_x: 54.8
shaper_type_x: ei
shaper_freq_y: 34.0
shaper_type_y: mzv

#virtual SD
[virtual_sdcard]
path: ~/printer_data/gcodes
on_error_gcode: CANCEL_PRINT

#x stepper
[stepper_x]
step_pin: PA12
dir_pin: PA11
enable_pin: !PA15
microsteps: 16
rotation_distance: 40
endstop_pin: ^!PB11
position_endstop: -10
position_min: -14
position_max: 220
homing_speed: 100
homing_retract_dist: 5

#y stepper
[stepper_y]
step_pin: PA9
dir_pin: !PA8
enable_pin: !PA15
microsteps: 16
rotation_distance: 40
endstop_pin: ^!PC13
position_endstop: -2
position_min: -3
position_max: 230
homing_speed: 100
homing_retract_dist: 5

#z stepper
[stepper_z]
step_pin: PB0
dir_pin: !PB1
enable_pin: !PA15
microsteps: 16
rotation_distance: 8
endstop_pin: probe:z_virtual_endstop
position_min: -2
position_max: 200
homing_speed: 15
second_homing_speed: 2
homing_retract_dist: 2

#extruder config
[extruder]
max_extrude_cross_section: 5.0
step_pin: PB15
dir_pin: PB14
enable_pin: !PA15
microsteps: 16
max_extrude_only_distance: 200
max_extrude_only_velocity: 80
max_extrude_only_accel: 5000
rotation_distance: 7.084 	# Kalibruj jeśli zauważysz under/over extrusion
nozzle_diameter: 0.400
filament_diameter: 1.750
pressure_advance: 0.06 		# Kalibruj dla swojego filamentu!
pressure_advance_smooth_time: 0.04
heater_pin: PB8
sensor_type: ATC Semitec 104GT-2
sensor_pin: PC3
min_extrude_temp: 180
min_temp: 0
max_temp: 250
control: pid
pid_kp: 14.42 	# Twoje skalibrowane wartości - dobre!
pid_ki: 0.88
pid_kd: 59.12

#hotbed
[heater_bed]
heater_pin: PB9
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PC1
min_temp: 0
max_temp: 120
control: pid
pid_kp: 97.1 	# Twoje skalibrowane wartości
pid_ki: 1.41
pid_kd: 1675.16

#inductive probe settings
[probe]
pin: PA1
x_offset: 24.0
y_offset: 13.35
#z_offset: 0 		# Będzie zapisany automatycznie w SAVE_CONFIG
samples: 3
samples_result: average
sample_retract_dist: 2
speed: 15
lift_speed: 8
samples_tolerance: 0.1
samples_tolerance_retries: 3

#auto bed level settings
[bed_mesh]
speed: 200
horizontal_move_z: 3
mesh_min: 14, 11
mesh_max: 210, 215
probe_count: 7,7 		# Możesz zwiększyć do 9,9 dla lepszej precyzji
mesh_pps: 4,4 
algorithm: bicubic
bicubic_tension: 0.2
fade_start: 1.0 		# Dodane - stopniowe zanikanie bed mesh
fade_end: 10.0 		# Dodane
fade_target: 0 		# Dodane

#safe z home
[safe_z_home]
home_xy_position: 110, 110
speed: 100
z_hop: 10
z_hop_speed: 15

#fans
[controller_fan controller_fan]
pin: PB12
stepper: stepper_x,stepper_y,stepper_z,extruder
idle_timeout: 60

[heater_fan extruder_fan]
pin: PB13
heater: extruder
heater_temp: 50.0

[fan]
pin: PB5
cycle_time: 0.00005 	# 20kHz - zmniejsza hałas
kick_start_time: 0.5

#Enable pin - POPRAWIONE (był błąd static_value)
[output_pin enable_pin]
pin: PB6
value: 1 			# ZMIENIONE z static_value na value

# ===== DODATKOWE FUNKCJE =====

#Wirtualny SD Card restart
[pause_resume]

#Cancel print
[display_status]

#Gcode arcs support
[gcode_arcs]
resolution: 0.1

#Exclude objects - przydatne gdy druk się nie udaje
[exclude_object]

# ===== MAKRA POMOCNICZE =====

[gcode_macro START_PRINT]
gcode:
    {% set BED_TEMP = params.BED_TEMP|default(60)|float %}
    {% set EXTRUDER_TEMP = params.EXTRUDER_TEMP|default(200)|float %}
    
    M140 S{BED_TEMP}    # Ustaw temperaturę stołu
    M104 S150           # Podgrzej hotend do 150°C
    G28                 # Home wszystkie osie
    M190 S{BED_TEMP}    # Czekaj na temperaturę stołu
    BED_MESH_CALIBRATE  # Kalibracja bed mesh
    G1 Z50 F3000        # Podnieś Z
    M109 S{EXTRUDER_TEMP} # Czekaj na temperaturę hotend
    G92 E0              # Reset ekstrudera
    G1 E10 F300         # Wyciśnij trochę filamentu
    G92 E0              # Reset ekstrudera znowu
    G1 F9000

[gcode_macro END_PRINT]
gcode:
    G91                 # Relative positioning
    G1 E-2 F2700        # Retract
    G1 X-2 Y-2 E-3 F300 # Cofnij i wycofaj więcej filamentu
    G1 Z10 F3000        # Podnieś nozzle
    G90                 # Absolute positioning
    G1 X0 Y220 F3000    # Przesuń łeb do przodu
    M106 S0             # Wyłącz wentylator
    M104 S0             # Wyłącz hotend
    M140 S0             # Wyłącz stół
    M84                 # Wyłącz silniki

[gcode_macro PAUSE]
description: Pause the actual running print
rename_existing: PAUSE_BASE
gcode:
    PAUSE_BASE
    _TOOLHEAD_PARK_PAUSE_CANCEL

[gcode_macro RESUME]
description: Resume the actual running print
rename_existing: RESUME_BASE
gcode:
    ##### read E from pause macro #####
    {% set E = printer["gcode_macro PAUSE"].extrude|float %}
    G91
    G1 E{E} F2100
    RESUME_BASE

[gcode_macro CANCEL_PRINT]
description: Cancel the actual running print
rename_existing: CANCEL_PRINT_BASE
gcode:
    TURN_OFF_HEATERS
    CANCEL_PRINT_BASE
    G91
    G1 Z10 F3000
    G90
    G1 X0 Y220 F3000

[gcode_macro _TOOLHEAD_PARK_PAUSE_CANCEL]
description: Helper: park toolhead used in PAUSE and CANCEL_PRINT
gcode:
    {% set x_park = 10 %}
    {% set y_park = 10 %}
    {% set z_hop = 10 %}
    {% set travel_speed = 100 * 60 %}
    {% set z_hop_speed = 15 * 60 %}
    G91
    G1 Z{z_hop} F{z_hop_speed}
    G90
    G1 X{x_park} Y{y_park} F{travel_speed}

[include moonraker_obico_macros.cfg]

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [probe]
#*# z_offset = 1.399
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  0.170833, 0.253333, 0.405000, 0.565833, 0.736667, 0.914167, 1.129167
#*# 	  0.051667, 0.106667, 0.224167, 0.347500, 0.453333, 0.626667, 0.766667
#*# 	  -0.118333, -0.041667, 0.083333, 0.211667, 0.353333, 0.536667, 0.689167
#*# 	  -0.154167, -0.140833, -0.069167, 0.005000, 0.077500, 0.190000, 0.254167
#*# 	  -0.295833, -0.306667, -0.262500, -0.197500, -0.129167, -0.030833, 0.034167
#*# 	  -0.340000, -0.415000, -0.432500, -0.406667, -0.396667, -0.375000, -0.395833
#*# 	  -0.603333, -0.680833, -0.699167, -0.675000, -0.648333, -0.578333, -0.573333
#*# x_count = 7
#*# y_count = 7
#*# mesh_x_pps = 4
#*# mesh_y_pps = 4
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 14.0
#*# max_x = 209.95999999999998
#*# min_y = 11.0
#*# max_y = 215.0
