# -*- coding: utf-8 -*-
# =============================================================================
# LOGIKA PAUSE / RESUME / CANCEL - MAINSAIL CLIENT
# =============================================================================
# Obsługuje wstrzymywanie i wznawianie druków z automatycznym parkowaniem głowicy
# Używa zmiennych z [gcode_macro _CLIENT_VARIABLE] w printer.cfg
# =============================================================================

# =============================================================================
# CANCEL_PRINT - ANULOWANIE DRUKU
# =============================================================================
[gcode_macro CANCEL_PRINT]
description: Anuluje bieżący druk z bezpiecznym parkowaniem i wyłączeniem
rename_existing: CANCEL_PRINT_BASE  # Oryginalna komenda Klipper → CANCEL_PRINT_BASE
gcode:
  # --- POBIERANIE ZMIENNYCH Z KONFIGURACJI ---
  {% set client = printer['gcode_macro _CLIENT_VARIABLE']|default({}) %}
  {% set allow_park = client.park_at_cancel|default(false)|lower == 'true' %}
  {% set retract = client.cancel_retract|default(5.0)|abs %}
  
  # --- RETRAKCJA FILAMENTU ---
  # Zapobiega kapieniu podczas parkowania
  _CLIENT_RETRACT LENGTH={retract}
  
  # --- PARKOWANIE GŁOWICY (OPCJONALNE) ---
  {% if allow_park %}
    _TOOLHEAD_PARK_PAUSE_CANCEL
  {% endif %}
  
  # --- WYŁĄCZENIE GRZANIA I WENTYLATORÓW ---
  TURN_OFF_HEATERS      # Wyłącza wszystkie grzałki (dysza + stół)
  M106 S0               # Wyłącza wentylator materiału (M106 S0 = 0% PWM)
  
  # --- WYWOŁANIE ORYGINALNEJ KOMENDY KLIPPER ---
  CANCEL_PRINT_BASE
  
  # --- WYŁĄCZENIE SILNIKÓW ---
  M84                   # Disable all steppers (oszczędność energii, chłodzenie)
  
  # --- CZYSZCZENIE STANU PAUZY ---
  CLEAR_PAUSE           # Resetuje flagi pauzowania w Klipperze
  
  M117 Druk anulowany

# =============================================================================
# PAUSE - WSTRZYMANIE DRUKU
# =============================================================================
[gcode_macro PAUSE]
description: Wstrzymuje druk z parkowaniem głowicy i retracją
rename_existing: PAUSE_BASE  # Oryginalna komenda Klipper → PAUSE_BASE
gcode:
  # --- WYWOŁANIE ORYGINALNEJ PAUZY ---
  PAUSE_BASE
  
  # --- PARKOWANIE GŁOWICY ---
  # {rawparams} przekazuje wszystkie dodatkowe parametry z komendy PAUSE
  _TOOLHEAD_PARK_PAUSE_CANCEL {rawparams}
  
  M117 Druk wstrzymany

# =============================================================================
# RESUME - WZNOWIENIE DRUKU
# =============================================================================
[gcode_macro RESUME]
description: Wznawia druk po pauzie z automatycznym unretract
rename_existing: RESUME_BASE  # Oryginalna komenda Klipper → RESUME_BASE
gcode:
  # --- POBIERANIE ZMIENNYCH ---
  {% set client = printer['gcode_macro _CLIENT_VARIABLE']|default({}) %}
  {% set velocity = client.speed_move|default(100) %}      # Prędkość powrotu do pozycji
  {% set unretract = client.unretract|default(1.0)|abs %}  # Ilość filamentu do wyciągnięcia
  
  # --- UNRETRACT (odwrócenie retrakcji) ---
  # Sprawdzamy czy dysza może ekstruzję (temp > min_extrude_temp)
  {% if printer[printer.toolhead.extruder].can_extrude %}
    G91                 # Tryb względny
    G1 E{unretract} F2100  # Wyciągnij filament (2100 mm/min = 35 mm/s)
    G90                 # Tryb absolutny
  {% else %}
    RESPOND MSG="OSTRZEŻENIE: Dysza za zimna do unretract, pomijam"
  {% endif %}
  
  # --- WYWOŁANIE ORYGINALNEJ KOMENDY RESUME ---
  RESUME_BASE VELOCITY={velocity}
  
  M117 Wznowiono druk

# =============================================================================
# _TOOLHEAD_PARK_PAUSE_CANCEL - POMOCNIK PARKOWANIA
# =============================================================================
# Wewnętrzne makro wywoływane przez PAUSE i CANCEL_PRINT
# NIE WYWOŁUJ BEZPOŚREDNIO (prefiks _ oznacza "internal")
[gcode_macro _TOOLHEAD_PARK_PAUSE_CANCEL]
description: Parkuje głowicę w bezpiecznej pozycji z podniesioną osią Z
gcode:
  # --- POBIERANIE PARAMETRÓW PARKOWANIA ---
  {% set client = printer['gcode_macro _CLIENT_VARIABLE']|default({}) %}
  {% set x_park = client.custom_park_x|default(110.0)|float %}   # Pozycja X
  {% set y_park = client.custom_park_y|default(10.0)|float %}    # Pozycja Y
  {% set z_lift = client.custom_park_dz|default(10.0)|float %}   # Podniesienie Z
  {% set speed = client.speed_move|default(150.0)|float * 60 %}  # Prędkość [mm/min]
  
  # --- OBLICZANIE BEZPIECZNEJ WYSOKOŚCI Z ---
  {% set max_z = printer.toolhead.axis_maximum.z|float %}  # Maksymalne Z z konfiguracji
  {% set act_z = printer.toolhead.position.z|float %}      # Aktualna pozycja Z
  {% set z_park = [act_z + z_lift, max_z]|min %}           # Nie przekraczaj max_z
  
  # --- SPRAWDZENIE CZY OSIE SĄ ZBAZOWANE ---
  {% if "xyz" in printer.toolhead.homed_axes %}
    # Bezpieczne parkowanie (osie zbazowane)
    G90                         # Tryb absolutny
    G1 Z{z_park} F3000          # Najpierw podnieś Z (zapobiega kolizji)
    G1 X{x_park} Y{y_park} F{speed}  # Ruch do pozycji parkowania
  {% else %}
    # Ostrzeżenie gdy osie nie zbazowane
    {action_respond_info("OSTRZEŻENIE: Printer not homed - parkowanie pominięte")}
  {% endif %}

# =============================================================================
# _CLIENT_RETRACT - POMOCNIK RETRAKCJI
# =============================================================================
# Wewnętrzne makro do wykonywania retrakcji z walidacją temperatury
[gcode_macro _CLIENT_RETRACT]
description: Wykonuje retrakcję filamentu z walidacją temperatury dyszy
gcode:
  {% set length = params.LENGTH|default(1.0)|float %}
  
  # --- SPRAWDZENIE CZY MOŻNA EKSTRUZJĘ ---
  {% if printer[printer.toolhead.extruder].can_extrude %}
    G91                 # Tryb względny
    G1 E-{length} F2100 # Retrakcja (ujemna wartość E)
    G90                 # Tryb absolutny
  {% else %}
    RESPOND MSG="OSTRZEŻENIE: Dysza za zimna, retrakcja pominięta"
  {% endif %}

# =============================================================================
# KONIEC PLIKU pause_resume.cfg
# =============================================================================
# UWAGI:
# - Zmienne parkowania konfiguruj w [gcode_macro _CLIENT_VARIABLE] w printer.cfg
# - Domyślne wartości:
#   * park_at_cancel: True (parkuj przy CANCEL)
#   * custom_park_x: 110.0 (środek osi X)
#   * custom_park_y: 10.0 (przód stołu)
#   * custom_park_dz: 10.0 (podniesienie o 10mm)
#   * cancel_retract: 5.0mm (retrakcja przy CANCEL)
#   * unretract: 1.0mm (wyciągnięcie przy RESUME)
# =============================================================================