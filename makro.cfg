# -*- coding: utf-8 -*-
# =============================================================================
# MAKRA UŻYTKOWNIKA - ANYCUBIC KOBRA 2 NEO
# =============================================================================
# Zawartość:
#   GRUPA 1: Makra START/END druku (dla slicera)
#   GRUPA 2: Kalibracje materiałowe (PLA/PETG/TPU)
#   GRUPA 3: Narzędzia serwisowe
# =============================================================================

# =============================================================================
# GRUPA 1: MAKRA STARTU I KOŃCA DRUKU (DLA SLICERA)
# =============================================================================

# -----------------------------------------------------------------------------
# GŁÓWNE MAKRO STARTU (wywoływane przez Slicer)
# -----------------------------------------------------------------------------
# Użycie w Slicerze (Start G-code):
#   START_PRINT BED_TEMP=[first_layer_bed_temperature] EXTRUDER_TEMP=[first_layer_temperature] MATERIAL=PLA
# -----------------------------------------------------------------------------
[gcode_macro START_PRINT]
description: Główny start wydruku z Adaptive Mesh, profilami materiałów i pauzą na adhezję
gcode:
    # === OVERRIDE PROFILE (DODANE) ===
    {% set state = printer['gcode_macro _PRINT_PROFILE_STATE'] %}
    _APPLY_PROFILE PROFILE={state.active_profile}
    RESPOND MSG="START_PRINT używa profilu: {state.active_profile}"
  # --- POBIERZ TEMPERATURY Z PROFILU LUB PARAMETRÓW ---
  {% set temp_state = printer["gcode_macro _TEMP_PROFILE_STATE"] %}

  # Jeśli profil temperatury jest aktywny (np. PLA_HOT), użyj jego wartości
  {% if temp_state.active_profile != "NONE" and temp_state.last_bed_temp > 0 %}
    {% set BED_TEMP = temp_state.last_bed_temp %}
    {% set EXTRUDER_TEMP = temp_state.last_extruder_temp %}
    RESPOND MSG="Temperatury z profilu {temp_state.active_profile}: Dysza {EXTRUDER_TEMP}°C | Stół {BED_TEMP}°C"
  {% else %}
    # Fallback na parametry ze slicera (gdy brak aktywnego profilu)
    {% if params.BED_TEMP is not defined %}
      RESPOND MSG="OSTRZEŻENIE: Brak profilu i BED_TEMP, używam 60°C"
      {% set BED_TEMP = 60 %}
    {% else %}
      {% set BED_TEMP = params.BED_TEMP|float %}
    {% endif %}

    {% if params.EXTRUDER_TEMP is not defined %}
      RESPOND MSG="OSTRZEŻENIE: Brak profilu i EXTRUDER_TEMP, używam 205°C"
      {% set EXTRUDER_TEMP = 205 %}
    {% else %}
      {% set EXTRUDER_TEMP = params.EXTRUDER_TEMP|float %}
    {% endif %}
    RESPOND MSG="Temperatury ze slicera: Dysza {EXTRUDER_TEMP}°C | Stół {BED_TEMP}°C"
  {% endif %}

  {% set MATERIAL = params.MATERIAL|default("PLA")|upper %}
  {% set SKIP_PAUSE = params.SKIP_PAUSE|default(0)|int %}

  # --- KROK 1: USTAWIENIE PROFILU MATERIAŁU ---
  M117 Ustawiam profil: {MATERIAL}
  {% if MATERIAL == "PETG" %}
    SET_FILAMENT_PETG
  {% elif MATERIAL == "TPU" %}
    SET_FILAMENT_TPU
  {% elif MATERIAL == "ABS" %}
    SET_FILAMENT_ABS
  {% elif MATERIAL == "ASA" %}
    SET_FILAMENT_ASA
  {% else %}
    SET_FILAMENT_PLA
  {% endif %}

  # --- KROK 2: BAZOWANIE I PRZYGOTOWANIE ---
  M117 Bazowanie osi...
  _FAN_OFF_FIRST_LAYER
# Wywołanie makro _FAN_OFF_FIRST_LAYER (internal function)
# Wykonuje: M106 S0 (wyłącza fan przed rozpoczęciem druku)
# Umieszczenie przed G28 - fan OFF przed home (zapobiega chłodzeniu bed przed drukiem)
  G28                   # Bazowanie wszystkich osi
  M83                   # Ekstruder w trybie względnym
  G90                   # Pozycjonowanie absolutne
  M107                  # Wyłącz wentylator (ważne dla pierwszej warstwy!)

  # --- KROK 3: ROZPOCZĘCIE NAGRZEWANIA ---
  M117 Nagrzewanie stołu: {BED_TEMP}°C
  M140 S{BED_TEMP}      # Asynchroniczne grzanie stołu
  M104 S{EXTRUDER_TEMP|int - 40}  # Wstępne nagrzewanie dyszy (40°C poniżej docelowej)

  # --- KROK 4: RUCH DO POZYCJI OCZEKIWANIA ---
  G1 Z50 F3000          # Podnieś Z do 50mm
  G1 X0 Y0 F5000        # Ruch do przedniego lewego rogu

  # --- KROK 5: CZEKANIE NA STÓŁ I OPCJONALNA PAUZA ---
  M190 S{BED_TEMP}      # Czekaj na temperaturę stołu

  {% if SKIP_PAUSE == 0 %}
    M117 Nałóż środek adhezyjny!
    RESPOND MSG="Stół nagrzany ({BED_TEMP}°C). Nałóż klej/taśmę i kliknij RESUME. (Pomiń: SKIP_PAUSE=1)"
    PAUSE
  {% else %}
    RESPOND MSG="Pauza pominięta (SKIP_PAUSE=1)"
  {% endif %}

  # --- KROK 6: ADAPTACYJNE POZIOMOWANIE ---
  M117 Poziomowanie adaptacyjne...
  BED_MESH_CALIBRATE ADAPTIVE=1

  # --- KROK 7: FINALNE NAGRZEWANIE DYSZY ---
  M117 Nagrzewanie dyszy: {EXTRUDER_TEMP}°C
  M109 S{EXTRUDER_TEMP}

  # --- KROK 8: LINIA CZYSZCZĄCA ---
  _LINIA_CZYSZCZACA MAT={MATERIAL}

  # --- KROK 9: USTAWIENIA WENTYLATORA DLA MATERIAŁU ---
  # Wentylator wyłączony dla pierwszej warstwy (ustawiony przez M107 wcześniej)
  # Slicer powinien włączyć wentylator od warstwy 2-3
  {% if MATERIAL == "ABS" or MATERIAL == "ASA" %}
    RESPOND MSG="ABS/ASA: Wentylator wyłączony przez cały druk"
  {% elif MATERIAL == "PETG" %}
    RESPOND MSG="PETG: Wentylator 30-50% od warstwy 3"
  {% elif MATERIAL == "TPU" %}
    RESPOND MSG="TPU: Wentylator 0-30% (ustaw w slicerze)"
  {% else %}
    RESPOND MSG="PLA: Wentylator 100% od warstwy 2"
  {% endif %}

  RESPOND MSG="Rozpoczynam druk {MATERIAL} ({EXTRUDER_TEMP}°C / {BED_TEMP}°C)"
  M117 Druk: {MATERIAL}

# -----------------------------------------------------------------------------
# LINIA CZYSZCZĄCA (purge line) - makro wewnętrzne
# -----------------------------------------------------------------------------
[gcode_macro _LINIA_CZYSZCZACA]
description: Rysuje linię czyszczącą na krawędzi stołu (zoptymalizowana dla każdego materiału)
gcode:
  {% set MAT = params.MAT|default("PLA")|upper %}

  M117 Czyszczenie dyszy...
  G1 X2 Y20 Z0.28 F5000.0   # Ruch do punktu startowego

  # --- PARAMETRY ZALEŻNE OD MATERIAŁU ---
  {% if MAT == "PETG" %}
    # PETG: wolniej, więcej ekstruzji (wysoka lepkość)
    G1 X2 Y120 Z0.28 F600 E12      # Linia 100mm
    G1 X2.4 Y120 Z0.28 F3000       # Przeskok
    G1 X2.4 Y20 Z0.28 F800 E24     # Powrót
  {% elif MAT == "TPU" %}
    # TPU: bardzo wolno, minimalna ekstruzja
    G1 X2 Y100 Z0.30 F400 E8       # Linia 80mm
    G1 X2.5 Y100 Z0.30 F2000       # Przeskok
    G1 X2.5 Y20 Z0.30 F500 E16     # Powrót
  {% elif MAT == "ABS" or MAT == "ASA" %}
    # ABS/ASA: średnia prędkość
    G1 X2 Y120 Z0.28 F1000 E10     # Linia 100mm
    G1 X2.4 Y120 Z0.28 F3000       # Przeskok
    G1 X2.4 Y20 Z0.28 F1200 E20    # Powrót
  {% else %}
    # PLA: szybko, optymalna ekstruzja
    G1 X2 Y120 Z0.26 F1500 E8      # Linia 100mm (mniej niż wcześniej!)
    G1 X2.4 Y120 Z0.26 F4000       # Szybki przeskok
    G1 X2.4 Y20 Z0.26 F1800 E16    # Powrót
  {% endif %}

  # Krótka retrakcja po linii (zapobiega kapaniu)
  G1 E-0.5 F2000
  G1 Z0.5 F1000               # Podniesienie dyszy
  G92 E0                      # Reset licznika filamentu

# -----------------------------------------------------------------------------
# GŁÓWNE MAKRO KOŃCA DRUKU
# -----------------------------------------------------------------------------
[gcode_macro END_PRINT]
description: Wywoływane przez Slicer na końcu druku (bezpieczne zakończenie)
gcode:
  M117 Kończenie druku...

  # --- ZAPISZ AKTUALNĄ POZYCJĘ Z ---
  {% set max_z = printer.toolhead.axis_maximum.z|float %}
  {% set act_z = printer.toolhead.position.z|float %}
  {% set lift_z = 15 %}
  {% if act_z < (max_z - lift_z) %}
    {% set z_safe = lift_z %}
  {% else %}
    {% set z_safe = max_z - act_z %}
  {% endif %}

  # --- RETRAKCJA I PODNIESIENIE ---
  G91                   # Tryb względny
  G1 E-3 F2400          # Retrakcja 3mm (zwiększona)
  G1 Z{z_safe} F3000    # Bezpieczne podniesienie Z
  G1 E-5 F1800          # Dodatkowa retrakcja po podniesieniu (całkiem -8mm)

  # --- PARKOWANIE GŁOWICY ---
  G90                   # Tryb absolutny
  G1 X10 Y210 F6000     # Parkuj w rogu (łatwy dostęp do wydruku)

  # --- CHŁODZENIE DYSZY PRZED WYŁĄCZENIEM ---
  M104 S0               # Wyłącz grzanie dyszy
  M140 S0               # Wyłącz grzanie stołu
  M106 S128             # Wentylator na 50% - przyspiesza chłodzenie dyszy

  # --- CZEKAJ NA SCHŁODZENIE DYSZY (opcjonalne) ---
  # Można odkomentować dla bezpieczeństwa:
  # M117 Chłodzenie dyszy...
  # TEMPERATURE_WAIT SENSOR=extruder MAXIMUM=50

  M107                  # Wyłącz wentylator
  M84                   # Wyłącz silniki

  RESPOND MSG="Wydruk ukończony! Można zdjąć model."
  M117 Gotowe!

# =============================================================================
# GRUPA 2: KALIBRACJE MATERIAŁOWE (PLA / PETG / TPU / ABS / ASA)
# =============================================================================
# Te makra przeprowadzają pełną kalibrację PID + Bed Mesh dla danego materiału
# UWAGA: Proces zajmuje ~30-45 minut, kończy się automatycznym SAVE_CONFIG (restart)

# -----------------------------------------------------------------------------
# KALIBRACJA DLA PLA (zoptymalizowane temperatury)
# -----------------------------------------------------------------------------
[gcode_macro PLA_KALIBRACJA]
description: Pełna kalibracja dla PLA (205°C dysza / 60°C stół)
gcode:
  _PELNA_KALIBRACJA_MAT B_TEMP=60 E_TEMP=205 MAT="PLA"

# -----------------------------------------------------------------------------
# KALIBRACJA DLA PETG
# -----------------------------------------------------------------------------
[gcode_macro PETG_KALIBRACJA]
description: Pełna kalibracja dla PETG (235°C dysza / 80°C stół)
gcode:
  _PELNA_KALIBRACJA_MAT B_TEMP=80 E_TEMP=235 MAT="PETG"

# -----------------------------------------------------------------------------
# KALIBRACJA DLA TPU
# -----------------------------------------------------------------------------
[gcode_macro TPU_KALIBRACJA]
description: Pełna kalibracja dla TPU (220°C dysza / 50°C stół)
gcode:
  _PELNA_KALIBRACJA_MAT B_TEMP=50 E_TEMP=220 MAT="TPU"

# -----------------------------------------------------------------------------
# KALIBRACJA DLA ABS
# -----------------------------------------------------------------------------
[gcode_macro ABS_KALIBRACJA]
description: Pełna kalibracja dla ABS (250°C dysza / 100°C stół)
gcode:
  _PELNA_KALIBRACJA_MAT B_TEMP=100 E_TEMP=250 MAT="ABS"

# -----------------------------------------------------------------------------
# KALIBRACJA DLA ASA
# -----------------------------------------------------------------------------
[gcode_macro ASA_KALIBRACJA]
description: Pełna kalibracja dla ASA (250°C dysza / 100°C stół)
gcode:
  _PELNA_KALIBRACJA_MAT B_TEMP=100 E_TEMP=250 MAT="ASA"

# -----------------------------------------------------------------------------
# UNIWERSALNE MAKRO KALIBRACJI - wewnętrzne (używane przez powyższe)
# -----------------------------------------------------------------------------
[gcode_macro _PELNA_KALIBRACJA_MAT]
description: Wykonuje PID tuning + Bed Mesh dla podanych temperatur
gcode:
  # --- PARAMETRY Z DOMYŚLNYMI WARTOŚCIAMI ---
  {% set B_TEMP = params.B_TEMP|default(60)|float %}
  {% set E_TEMP = params.E_TEMP|default(210)|float %}
  {% set MAT = params.MAT|default("PLA")|string %}
  
  RESPOND MSG="=== KALIBRACJA DLA {MAT} ==="
  RESPOND MSG="Temperatury: Dysza {E_TEMP}°C | Stół {B_TEMP}°C"
  RESPOND MSG="Szacowany czas: 30-45 minut"
  
  # --- BAZOWANIE ---
  G28
  
  # --- PID TUNING EXTRUDERA ---
  M117 PID Extrudera ({E_TEMP}°C)...
  RESPOND MSG="[1/3] Kalibracja PID dyszy - może potrwać 5-10 minut"
  PID_CALIBRATE HEATER=extruder TARGET={E_TEMP}
  
  # --- PID TUNING STOŁU ---
  M117 PID Stołu ({B_TEMP}°C)...
  RESPOND MSG="[2/3] Kalibracja PID stołu - może potrwać 10-15 minut"
  PID_CALIBRATE HEATER=heater_bed TARGET={B_TEMP}
  
  # --- CZEKANIE NA TEMPERATURĘ STOŁU ---
  M117 Czekam na stół {B_TEMP}°C...
  M190 S{B_TEMP}
  
  # --- BED MESH CALIBRATION ---
  M117 Tworzenie mapy Mesh (9x9)...
  RESPOND MSG="[3/3] Skanowanie stołu 9x9 - może potrwać 15-20 minut"
  BED_MESH_CALIBRATE
  
  # --- ZAPIS I RESTART ---
  RESPOND MSG="Kalibracja zakończona! Zapisuję konfigurację..."
  M117 Zapisywanie...
  SAVE_CONFIG  # Automatyczny restart Klippera po zapisie

# =============================================================================
# GRUPA 3: NARZĘDZIA SERWISOWE
# =============================================================================

# -----------------------------------------------------------------------------
# POZIOMOWANIE ŚRUB STOŁU
# -----------------------------------------------------------------------------
[gcode_macro POZIOMOWANIE_SRUBY]
description: Pomoc w mechanicznym ustawieniu śrub stołu (SCREWS_TILT_ADJUST)
gcode:
  M117 Przygotowanie do poziomowania...
  G28                   # Bazowanie
  M190 S60              # Nagrzej stół do 60°C (kompensacja rozszerzalności)
  M117 Skanowanie śrub...
  SCREWS_TILT_ADJUST    # Wykonaj pomiar nachylenia przy każdej śrubie
  # WYNIK: Konsola pokaże ile obrotów CW/CCW dla każdej śruby

# -----------------------------------------------------------------------------
# CZYSZCZENIE/TEST DYSZY
# -----------------------------------------------------------------------------
[gcode_macro CZYSZCZENIE_DYSZY]
description: Rozgrzewa dyszę i wypuszcza trochę filamentu (test grzania/ekstruzji)
gcode:
  {% set TEMP = params.TEMP|default(200)|float %}
  
  M117 Nagrzewanie do {TEMP}°C...
  M109 S{TEMP}          # Czekaj na temperaturę
  
  M117 Ekstruzja testowa...
  G91                   # Tryb względny
  G1 E20 F100           # Ekstruzja 20mm przy 100 mm/min (wolno, dla obserwacji)
  G90                   # Tryb absolutny
  
  RESPOND MSG="Test zakończony. Sprawdź czy filament wychodzi równomiernie."
  M117 Test OK

# -----------------------------------------------------------------------------
# MAKRO RATUNKOWE: WYŁĄCZENIE WSZYSTKIEGO
# -----------------------------------------------------------------------------
[gcode_macro EMERGENCY_STOP]
description: Awaryjne zatrzymanie - wyłącza grzanie, wentylatory i silniki
gcode:
  M112  # Emergency stop Klipper (wymaga FIRMWARE_RESTART do wznowienia)

[gcode_macro LAYER_CHANGE]
# Makro wywoływane przez slicer przy każdej zmianie warstwy
# OrcaSlicer wstawia: LAYER_CHANGE LAYER=[layer_num] w G-code
gcode:
    {% set layer = params.LAYER|default(0)|int %}
    # params.LAYER - parametr z slicer ([layer_num] → 0, 1, 2, 3...)
    # |default(0) - fallback jeśli slicer nie podał LAYER
    # |int - konwersja string "5" → integer 5
    
    SET_FAN_FOR_LAYER LAYER={layer}
    # Wywołanie makro SET_FAN_FOR_LAYER z parametrem LAYER
    # {layer} - Jinja2 placeholder: wstawia wartość zmiennej layer
    # Automatycznie dostosowuje fan speed based on layer number
# =============================================================================
# KONIEC PLIKU makro.cfg
# =============================================================================