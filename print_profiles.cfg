# =============================================================================
# SYSTEM PROFILI DRUKU - FULL PACKAGE v1.1 (FIXED)
# =============================================================================
# Autor: Damian | Data: 2024-12-27 | Fix: Nested dict syntax
# =============================================================================

# =============================================================================
# SEKCJA 1: STORAGE PROFILI (FIXED FORMAT)
# =============================================================================

[gcode_macro _PRINT_PROFILE_STATE]
description: Storage dla aktywnego profilu (nie klikaƒá - internal)
variable_active_profile: "BALANCED"
# Profile stored as individual variables (Klipper-compatible format)
variable_quality: {'max_velocity': 200, 'max_accel': 2500, 'square_corner_velocity': 6.0, 'pressure_advance': 0.042, 'retract_length': 0.9, 'retract_speed': 40, 'description': 'Maksymalna jako≈õƒá - wolne, g≈Çadkie ≈õciany'}
variable_balanced: {'max_velocity': 250, 'max_accel': 3500, 'square_corner_velocity': 8.0, 'pressure_advance': 0.04, 'retract_length': 0.8, 'retract_speed': 45, 'description': 'Baseline - optymalne ustawienia'}
variable_speed: {'max_velocity': 300, 'max_accel': 5000, 'square_corner_velocity': 10.0, 'pressure_advance': 0.038, 'retract_length': 0.7, 'retract_speed': 50, 'description': 'Szybki druk - prototypy'}
variable_assembly: {'max_velocity': 220, 'max_accel': 2800, 'square_corner_velocity': 7.0, 'pressure_advance': 0.042, 'retract_length': 0.85, 'retract_speed': 42, 'description': 'Precyzja wymiarowa'}
gcode:
    # Puste - tylko variable storage

# =============================================================================
# SEKCJA 2: MAKRO WEWNƒòTRZNE - APLIKACJA PROFILU (FIXED)
# =============================================================================

[gcode_macro _APPLY_PROFILE]
description: Internal - aplikuje profil
gcode:
    {% set profile_name = params.PROFILE|default("BALANCED")|string|lower %}
    {% set state = printer['gcode_macro _PRINT_PROFILE_STATE'] %}
    
    # Select profile based on name
    {% if profile_name == "quality" %}
        {% set profile = state.quality %}
    {% elif profile_name == "balanced" %}
        {% set profile = state.balanced %}
    {% elif profile_name == "speed" %}
        {% set profile = state.speed %}
    {% elif profile_name == "assembly" %}
        {% set profile = state.assembly %}
    {% else %}
        {% set profile = state.balanced %}  # Fallback
    {% endif %}
    
    # Zastosuj limity prƒôdko≈õci/akceleracji
    SET_VELOCITY_LIMIT VELOCITY={profile.max_velocity} ACCEL={profile.max_accel} SQUARE_CORNER_VELOCITY={profile.square_corner_velocity}
    
    # Zastosuj Pressure Advance
    SET_PRESSURE_ADVANCE ADVANCE={profile.pressure_advance}
    
    # Zastosuj firmware retraction (je≈õli w≈ÇƒÖczone)
    {% if printer.firmware_retraction %}
        SET_RETRACTION RETRACT_LENGTH={profile.retract_length} RETRACT_SPEED={profile.retract_speed}
    {% endif %}
    
    # Reset speed/flow multipliers do 100%
    M220 S100
    M221 S100
    
    # Log do konsoli
    RESPOND MSG="‚úì Profil '{profile_name|upper}' aktywny"
    RESPOND MSG="  Velocity: {profile.max_velocity}mm/s | Accel: {profile.max_accel}mm/s¬≤ | PA: {profile.pressure_advance}"

# =============================================================================
# SEKCJA 3: PROFILE PODSTAWOWE
# =============================================================================

[gcode_macro PROFILE_QUALITY]
description: üê¢ QUALITY - max jako≈õƒá (200mm/s, 2500accel)
gcode:
    SET_GCODE_VARIABLE MACRO=_PRINT_PROFILE_STATE VARIABLE=active_profile VALUE='"QUALITY"'
    _APPLY_PROFILE PROFILE=QUALITY
    RESPOND MSG="üê¢ QUALITY: Wolno ale g≈Çadko - idealne dla display prints"

[gcode_macro PROFILE_BALANCED]
description: ‚öñÔ∏è BALANCED - baseline (250mm/s, 3500accel)
gcode:
    SET_GCODE_VARIABLE MACRO=_PRINT_PROFILE_STATE VARIABLE=active_profile VALUE='"BALANCED"'
    _APPLY_PROFILE PROFILE=BALANCED
    RESPOND MSG="‚öñÔ∏è BALANCED: Domy≈õlne ustawienia"

[gcode_macro PROFILE_SPEED]
description: üöÄ SPEED - szybko (300mm/s, 5000accel)
gcode:
    SET_GCODE_VARIABLE MACRO=_PRINT_PROFILE_STATE VARIABLE=active_profile VALUE='"SPEED"'
    _APPLY_PROFILE PROFILE=SPEED
    RESPOND MSG="üöÄ SPEED: Prototypy - mo≈ºliwe artefakty"

[gcode_macro PROFILE_ASSEMBLY]
description: üîß ASSEMBLY - precyzja (220mm/s, 2800accel)
gcode:
    SET_GCODE_VARIABLE MACRO=_PRINT_PROFILE_STATE VARIABLE=active_profile VALUE='"ASSEMBLY"'
    _APPLY_PROFILE PROFILE=ASSEMBLY
    RESPOND MSG="üîß ASSEMBLY: Czƒô≈õci do z≈Ço≈ºenia ¬±0.1mm"

# =============================================================================
# SEKCJA 4: PROFILE SAFE (auto-pause)
# =============================================================================

[gcode_macro PROFILE_QUALITY_SAFE]
description: üõ°Ô∏è QUALITY SAFE - z auto-pause
gcode:
    {% if printer.idle_timeout.state == "Printing" %}
        RESPOND MSG="‚ö†Ô∏è Druk aktywny - PAUSE przed zmianƒÖ profilu"
        PAUSE
        G4 P2000
    {% endif %}
    SET_GCODE_VARIABLE MACRO=_PRINT_PROFILE_STATE VARIABLE=active_profile VALUE='"QUALITY"'
    _APPLY_PROFILE PROFILE=QUALITY
    {% if printer.idle_timeout.state == "Printing" %}
        RESPOND MSG="‚úì QUALITY aktywny - kliknij RESUME"
    {% endif %}

[gcode_macro PROFILE_BALANCED_SAFE]
description: üõ°Ô∏è BALANCED SAFE - z auto-pause
gcode:
    {% if printer.idle_timeout.state == "Printing" %}
        RESPOND MSG="‚ö†Ô∏è Druk aktywny - PAUSE przed zmianƒÖ profilu"
        PAUSE
        G4 P2000
    {% endif %}
    SET_GCODE_VARIABLE MACRO=_PRINT_PROFILE_STATE VARIABLE=active_profile VALUE='"BALANCED"'
    _APPLY_PROFILE PROFILE=BALANCED
    {% if printer.idle_timeout.state == "Printing" %}
        RESPOND MSG="‚úì BALANCED aktywny - kliknij RESUME"
    {% endif %}

[gcode_macro PROFILE_SPEED_SAFE]
description: üõ°Ô∏è SPEED SAFE - z auto-pause
gcode:
    {% if printer.idle_timeout.state == "Printing" %}
        RESPOND MSG="‚ö†Ô∏è Druk aktywny - PAUSE przed zmianƒÖ profilu"
        PAUSE
        G4 P2000
    {% endif %}
    SET_GCODE_VARIABLE MACRO=_PRINT_PROFILE_STATE VARIABLE=active_profile VALUE='"SPEED"'
    _APPLY_PROFILE PROFILE=SPEED
    {% if printer.idle_timeout.state == "Printing" %}
        RESPOND MSG="‚úì SPEED aktywny - kliknij RESUME"
    {% endif %}

[gcode_macro PROFILE_ASSEMBLY_SAFE]
description: üõ°Ô∏è ASSEMBLY SAFE - z auto-pause
gcode:
    {% if printer.idle_timeout.state == "Printing" %}
        RESPOND MSG="‚ö†Ô∏è Druk aktywny - PAUSE przed zmianƒÖ profilu"
        PAUSE
        G4 P2000
    {% endif %}
    SET_GCODE_VARIABLE MACRO=_PRINT_PROFILE_STATE VARIABLE=active_profile VALUE='"ASSEMBLY"'
    _APPLY_PROFILE PROFILE=ASSEMBLY
    {% if printer.idle_timeout.state == "Printing" %}
        RESPOND MSG="‚úì ASSEMBLY aktywny - kliknij RESUME"
    {% endif %}

# =============================================================================
# SEKCJA 5: QUICK ADJUSTMENTS - SPEED
# =============================================================================

[gcode_macro SPEED_50]
description: üê¢ Prƒôdko≈õƒá 50%
gcode:
    M220 S50
    RESPOND MSG="üê¢ Prƒôdko≈õƒá: 50%"

[gcode_macro SPEED_75]
description: üê¢ Prƒôdko≈õƒá 75%
gcode:
    M220 S75
    RESPOND MSG="üê¢ Prƒôdko≈õƒá: 75%"

[gcode_macro SPEED_100]
description: ‚öñÔ∏è Prƒôdko≈õƒá 100%
gcode:
    M220 S100
    RESPOND MSG="‚öñÔ∏è Prƒôdko≈õƒá: 100%"

[gcode_macro SPEED_125]
description: üöÄ Prƒôdko≈õƒá 125%
gcode:
    M220 S125
    RESPOND MSG="üöÄ Prƒôdko≈õƒá: 125%"

[gcode_macro SPEED_150]
description: üöÄ Prƒôdko≈õƒá 150%
gcode:
    M220 S150
    RESPOND MSG="üöÄ Prƒôdko≈õƒá: 150%"

# =============================================================================
# SEKCJA 6: QUICK ADJUSTMENTS - FLOW
# =============================================================================

[gcode_macro FLOW_90]
description: üíß Flow 90%
gcode:
    M221 S90
    RESPOND MSG="üíß Flow: 90%"

[gcode_macro FLOW_95]
description: üíß Flow 95%
gcode:
    M221 S95
    RESPOND MSG="üíß Flow: 95%"

[gcode_macro FLOW_100]
description: üíß Flow 100%
gcode:
    M221 S100
    RESPOND MSG="üíß Flow: 100%"

[gcode_macro FLOW_105]
description: üíß Flow 105%
gcode:
    M221 S105
    RESPOND MSG="üíß Flow: 105%"

[gcode_macro FLOW_110]
description: üíß Flow 110%
gcode:
    M221 S110
    RESPOND MSG="üíß Flow: 110%"

# =============================================================================
# SEKCJA 7: UTILITY MACROS
# =============================================================================

[gcode_macro PROFILE_RESET]
description: üîÑ Reset do BALANCED + 100%/100%
gcode:
    SET_GCODE_VARIABLE MACRO=_PRINT_PROFILE_STATE VARIABLE=active_profile VALUE='"BALANCED"'
    _APPLY_PROFILE PROFILE=BALANCED
    M220 S100
    M221 S100
    RESPOND MSG="üîÑ RESET: BALANCED + Speed 100% + Flow 100%"

[gcode_macro PROFILE_STATUS]
description: ‚ÑπÔ∏è Wy≈õwietl aktywny profil
gcode:
    {% set state = printer['gcode_macro _PRINT_PROFILE_STATE'] %}
    {% set active = state.active_profile|lower %}
    
    {% if active == "quality" %}
        {% set profile = state.quality %}
    {% elif active == "balanced" %}
        {% set profile = state.balanced %}
    {% elif active == "speed" %}
        {% set profile = state.speed %}
    {% elif active == "assembly" %}
        {% set profile = state.assembly %}
    {% else %}
        {% set profile = state.balanced %}
    {% endif %}
    
    RESPOND MSG="========================================="
    RESPOND MSG="AKTYWNY PROFIL: {active|upper}"
    RESPOND MSG="========================================="
    RESPOND MSG="Opis: {profile.description}"
    RESPOND MSG="-----------------------------------------"
    RESPOND MSG="Max velocity: {profile.max_velocity} mm/s"
    RESPOND MSG="Max accel: {profile.max_accel} mm/s¬≤"
    RESPOND MSG="Corner velocity: {profile.square_corner_velocity} mm/s"
    RESPOND MSG="Pressure Advance: {profile.pressure_advance}"
    RESPOND MSG="Retract: {profile.retract_length}mm @ {profile.retract_speed}mm/s"
    RESPOND MSG="-----------------------------------------"
    RESPOND MSG="Speed multiplier: {printer.gcode_move.speed_factor * 100|int}%"
    RESPOND MSG="Flow multiplier: {printer.gcode_move.extrude_factor * 100|int}%"
    RESPOND MSG="========================================="

[gcode_macro PROFILE_LIST]
description: üìã Lista dostƒôpnych profili
gcode:
    {% set state = printer['gcode_macro _PRINT_PROFILE_STATE'] %}
    
    RESPOND MSG="========================================="
    RESPOND MSG="DOSTƒòPNE PROFILE:"
    RESPOND MSG="========================================="
    RESPOND MSG="QUALITY: {state.quality.description}"
    RESPOND MSG="  Vel: {state.quality.max_velocity}mm/s | Accel: {state.quality.max_accel}mm/s¬≤"
    RESPOND MSG="-----------------------------------------"
    RESPOND MSG="BALANCED: {state.balanced.description}"
    RESPOND MSG="  Vel: {state.balanced.max_velocity}mm/s | Accel: {state.balanced.max_accel}mm/s¬≤"
    RESPOND MSG="-----------------------------------------"
    RESPOND MSG="SPEED: {state.speed.description}"
    RESPOND MSG="  Vel: {state.speed.max_velocity}mm/s | Accel: {state.speed.max_accel}mm/s¬≤"
    RESPOND MSG="-----------------------------------------"
    RESPOND MSG="ASSEMBLY: {state.assembly.description}"
    RESPOND MSG="  Vel: {state.assembly.max_velocity}mm/s | Accel: {state.assembly.max_accel}mm/s¬≤"
    RESPOND MSG="========================================="