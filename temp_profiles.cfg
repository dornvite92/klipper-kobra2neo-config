# ============================================================================
# TEMPERATURE PROFILES - Professional Lab Filaments
# System makr do szybkiej zmiany temperatur bez re-slicing
# Autor: Damian | Data: 2025-12-27
# ============================================================================

[gcode_macro _TEMP_PROFILE_STATE]
description: Stan profili temperatur (nie wywołuj bezpośrednio)
variable_active_profile: "NONE"
variable_last_extruder_temp: 0
variable_last_bed_temp: 0
variable_target_fan_speed: 0

# === PROFILE DEFINITIONS (single-line format dla Klipper parser) ===
# Format: {"extruder_temp": X, "bed_temp": Y, "fan_speed": Z, "retract_length": R, "description": "..."}

variable_pla: {"extruder_temp": 215, "bed_temp": 60, "fan_speed": 100, "retract_length": 1.8, "description": "PLA Professional Lab - balanced quality"}

variable_pla_hot: {"extruder_temp": 220, "bed_temp": 65, "fan_speed": 100, "retract_length": 1.8, "description": "PLA HOT - high speed prints (>100mm/s)"}

variable_pla_cold: {"extruder_temp": 210, "bed_temp": 55, "fan_speed": 100, "retract_length": 1.6, "description": "PLA COLD - high detail, minimal stringing"}

variable_petg: {"extruder_temp": 240, "bed_temp": 75, "fan_speed": 50, "retract_length": 2.5, "description": "PETG Professional Lab - functional parts"}

variable_petg_hot: {"extruder_temp": 250, "bed_temp": 80, "fan_speed": 30, "retract_length": 3.0, "description": "PETG HOT - maximum layer strength"}

variable_abs: {"extruder_temp": 245, "bed_temp": 100, "fan_speed": 0, "retract_length": 2.0, "description": "ABS - requires enclosure, no fan"}

variable_asa: {"extruder_temp": 250, "bed_temp": 95, "fan_speed": 10, "retract_length": 2.0, "description": "ASA - UV resistant, outdoor use"}

variable_tpu: {"extruder_temp": 220, "bed_temp": 50, "fan_speed": 100, "retract_length": 0.8, "description": "TPU 95A - flexible, print SLOW (30mm/s max)"}

gcode:
    # Dummy - ten makro tylko storage


# --- CORE APPLY FUNCTION ---
[gcode_macro _APPLY_TEMP_PROFILE]
description: Wewnętrzna funkcja - aplikuje profil
gcode:
    {% set profile_name = params.PROFILE|lower %}
    {% set state = printer["gcode_macro _TEMP_PROFILE_STATE"] %}
    
    # Wybór profilu
    {% if profile_name == "pla" %}
        {% set profile = state.pla %}
    {% elif profile_name == "pla_hot" %}
        {% set profile = state.pla_hot %}
    {% elif profile_name == "pla_cold" %}
        {% set profile = state.pla_cold %}
    {% elif profile_name == "petg" %}
        {% set profile = state.petg %}
    {% elif profile_name == "petg_hot" %}
        {% set profile = state.petg_hot %}
    {% elif profile_name == "abs" %}
        {% set profile = state.abs %}
    {% elif profile_name == "asa" %}
        {% set profile = state.asa %}
    {% elif profile_name == "tpu" %}
        {% set profile = state.tpu %}
    {% else %}
        RESPOND MSG="ERROR: Unknown profile {profile_name}"
        {% set profile = state.pla %}
    {% endif %}
    
    # SET TEMPERATURES
    M104 S{profile.extruder_temp}              # M104 - Set extruder temp (non-blocking), S = temperatura [°C]
    M140 S{profile.bed_temp}                   # M140 - Set bed temp (non-blocking), S = temperatura [°C]
    
    # SET FAN
    SET_GCODE_VARIABLE MACRO=_TEMP_PROFILE_STATE VARIABLE=target_fan_speed VALUE={profile.fan_speed}
    
    # SET RETRACTION
    {% if 'retract_length' in profile %}
        SET_RETRACTION RETRACT_LENGTH={profile.retract_length}  # Klipper firmware retraction command
    {% endif %}
    
    # UPDATE STATE
    SET_GCODE_VARIABLE MACRO=_TEMP_PROFILE_STATE VARIABLE=active_profile VALUE='"{profile_name.upper()}"'
    SET_GCODE_VARIABLE MACRO=_TEMP_PROFILE_STATE VARIABLE=last_extruder_temp VALUE={profile.extruder_temp}
    SET_GCODE_VARIABLE MACRO=_TEMP_PROFILE_STATE VARIABLE=last_bed_temp VALUE={profile.bed_temp}
    
    # FEEDBACK
    RESPOND MSG="Profile {profile_name.upper()}: Nozzle {profile.extruder_temp}C | Bed {profile.bed_temp}C | Fan {profile.fan_speed}% | Retract {profile.retract_length}mm"
    RESPOND MSG="{profile.description}"


# ============================================================================
# USER MACROS - Przyciski w Mainsail
# ============================================================================

# --- PLA ---
[gcode_macro TEMP_SET_PLA]
description: PLA 215C - Balanced (twoja optymalna)
gcode:
    _APPLY_TEMP_PROFILE PROFILE=PLA

[gcode_macro TEMP_SET_PLA_HOT]
description: PLA 220C - High Speed
gcode:
    _APPLY_TEMP_PROFILE PROFILE=PLA_HOT

[gcode_macro TEMP_SET_PLA_COLD]
description: PLA 210C - High Detail
gcode:
    _APPLY_TEMP_PROFILE PROFILE=PLA_COLD


# --- PETG ---
[gcode_macro TEMP_SET_PETG]
description: PETG 240C - Standard (Professional Lab)
gcode:
    _APPLY_TEMP_PROFILE PROFILE=PETG

[gcode_macro TEMP_SET_PETG_HOT]
description: PETG 250C - Max Strength
gcode:
    _APPLY_TEMP_PROFILE PROFILE=PETG_HOT


# --- ENGINEERING ---
[gcode_macro TEMP_SET_ABS]
description: ABS 245C - Requires enclosure
gcode:
    {% if printer.heaters.available_sensors|select("search","chamber")|list|length == 0 %}
        RESPOND MSG="WARNING: ABS requires enclosure!"
    {% endif %}
    _APPLY_TEMP_PROFILE PROFILE=ABS

[gcode_macro TEMP_SET_ASA]
description: ASA 250C - UV resistant
gcode:
    _APPLY_TEMP_PROFILE PROFILE=ASA

[gcode_macro TEMP_SET_TPU]
description: TPU 220C - Flexible (SLOW!)
gcode:
    RESPOND MSG="TPU: Print SLOW (max 30mm/s)"
    _APPLY_TEMP_PROFILE PROFILE=TPU


# --- UTILITY ---
[gcode_macro TEMP_STATUS]
description: Pokaz aktywny profil
gcode:
    {% set state = printer["gcode_macro _TEMP_PROFILE_STATE"] %}
    {% set current_e = printer.extruder.temperature %}
    {% set target_e = printer.extruder.target %}
    {% set current_b = printer.heater_bed.temperature %}
    {% set target_b = printer.heater_bed.target %}
    
    RESPOND MSG="====== TEMP STATUS ======"
    RESPOND MSG="Profile: {state.active_profile}"
    RESPOND MSG="Extruder: {current_e}C / {target_e}C"
    RESPOND MSG="Bed: {current_b}C / {target_b}C"
    RESPOND MSG="Last: {state.last_extruder_temp}C / {state.last_bed_temp}C"

[gcode_macro TEMP_COOLDOWN]
description: Emergency cooldown
gcode:
    M104 S0                                    # M104 S0 - wylacz extruder heater
    M140 S0                                    # M140 S0 - wylacz bed heater
    M106 S255                                  # M106 S255 - max fan (100%, 255/255)
    SET_GCODE_VARIABLE MACRO=_TEMP_PROFILE_STATE VARIABLE=active_profile VALUE='"COOLDOWN"'
    RESPOND MSG="COOLDOWN: All OFF, fan MAX"

[gcode_macro SET_FAN_FOR_LAYER]
# [gcode_macro NAME] - definicja Klipper macro
# Nazwa: SET_FAN_FOR_LAYER - automatyczne sterowanie fan based on layer number
description: Auto fan speed based on layer
# description - tekst wyświetlany w Mainsail interface (tooltip)
gcode:
    # gcode: - sekcja z executable G-code/Jinja2 commands
    
    {% set layer = params.LAYER|default(0)|int %}
    # {% set variable = value %} - Jinja2: deklaracja zmiennej lokalnej
    # params.LAYER - parametr przekazany do makro (np. SET_FAN_FOR_LAYER LAYER=5)
    # |default(0) - Jinja2 filter: jeśli LAYER nie podany, użyj 0
    # |int - konwersja string → integer
    
    {% set state = printer["gcode_macro _TEMP_PROFILE_STATE"] %}
    # printer["gcode_macro NAME"] - dostęp do innego macro w Klipper
    # Zwraca dictionary ze wszystkimi variables z _TEMP_PROFILE_STATE
    
    {% set target = state.target_fan_speed %}
    # state.target_fan_speed - odczyt variable z dictionary
    # Zawiera target fan speed z profilu (0-100%)
    
    # === LOGIKA RAMP-UP ===
    {% if layer <= 1 %}
        # if - Jinja2 conditional: warunek layer <= 1 (warstwy 0 i 1)
        {% set speed = 0 %}
        # Warstwa 0-1: fan OFF (100% adhezja do bed, zero warping risk)
        
    {% elif layer == 2 %}
        # elif - else if: layer równy dokładnie 2
        {% set speed = (target * 0.25)|int %}
        # Warstwa 2: 25% target speed
        # target * 0.25 - mnożenie: 100% → 25%
        # |int - round do integer (25.5 → 25)
        
    {% elif layer == 3 %}
        {% set speed = (target * 0.5)|int %}
        # Warstwa 3: 50% target speed
        
    {% elif layer == 4 %}
        {% set speed = (target * 0.75)|int %}
        # Warstwa 4: 75% target speed
        
    {% else %}
        # else - wszystkie pozostałe przypadki (layer >= 5)
        {% set speed = target %}
        # Warstwa 5+: pełna target speed (100%)
    {% endif %}
    # endif - zamknięcie bloku if
    
    M106 S{(speed * 2.55)|int}
    # M106 - Set fan speed (G-code standard command)
    # S - parametr: fan speed value
    # speed * 2.55 - konwersja 0-100% → 0-255 (Klipper internal scale)
    # Przykład: 50% → 50 * 2.55 = 127.5 → 127 (int)
    # {expression} - Jinja2 placeholder: evaluates expression i wstawia wynik


[gcode_macro _FAN_OFF_FIRST_LAYER]
# Makro pomocnicze: wyłącz fan na początku druku (call from START_PRINT)
gcode:
    M106 S0
    # M106 S0 - Set fan speed to 0 (OFF)
    # S0 - wartość 0/255 = 0% = fan całkowicie wyłączony
    # Zapewnia adhezję pierwszej warstwy do bed    