# Anycubic Kobra 2 Neo - Zoptymalizowana Konfiguracja
# Wersja 2.1.0 - Optymalizacje wydajności i niezawodności
# Board: Trigorilla 4.0.1

[include mainsail.cfg]
[include makro.cfg]
[include pause_resume.cfg]
#[include adxl.cfg]

# MCU Configuration
[mcu]
serial: /dev/serial/by-id/usb-1a86_USB_Serial-if00-port0
baud: 115200
restart_method: command

# Printer Settings - Zoptymalizowane
[printer]
kinematics: cartesian
max_velocity: 250
max_accel: 5000  # ZMIENIONE: Obniżone z 10000 dla lepszej jakości
minimum_cruise_ratio: 0.5  # NAPRAWIONE: Zastępuje max_accel_to_decel (nowsza wersja Klippera)
square_corner_velocity: 5.0  # DODANE: Redukcja wibracji na rogach
max_z_velocity: 8
max_z_accel: 800

# Input Shaper - Twoje zmierzone wartości
[input_shaper]
shaper_freq_x: 54.8
shaper_type_x: ei
shaper_freq_y: 34.0
shaper_type_y: mzv

# X Stepper
[stepper_x]
step_pin: PA12
dir_pin: PA11
enable_pin: !PA15
microsteps: 16
rotation_distance: 40
endstop_pin: ^!PB11
position_endstop: -10
position_min: -14
position_max: 220
homing_speed: 100
homing_retract_dist: 5  # DODANE: Bezpieczniejsze homing

# Y Stepper
[stepper_y]
step_pin: PA9
dir_pin: !PA8
enable_pin: !PA15
microsteps: 16
rotation_distance: 40
endstop_pin: ^!PC13
position_endstop: -2
position_min: -3
position_max: 230
homing_speed: 100
homing_retract_dist: 5  # DODANE

# Z Stepper
[stepper_z]
step_pin: PB0
dir_pin: !PB1
enable_pin: !PA15
microsteps: 16
rotation_distance: 8
endstop_pin: probe:z_virtual_endstop
position_min: -2
position_max: 200
homing_speed: 15
second_homing_speed: 2
homing_retract_dist: 3  # DODANE

# Extruder - NAPRAWIONE KOLEJNOŚĆ PID
[extruder]
step_pin: PB15
dir_pin: PB14
enable_pin: !PA15
microsteps: 16
max_extrude_cross_section: 5.0
max_extrude_only_distance: 200
max_extrude_only_velocity: 80
max_extrude_only_accel: 5000
rotation_distance: 7.084
nozzle_diameter: 0.400
filament_diameter: 1.750
heater_pin: PB8
sensor_type: ATC Semitec 104GT-2
sensor_pin: PC3
min_extrude_temp: 170
min_temp: 0
max_temp: 280
# PID Settings - POPRAWIONA KOLEJNOŚĆ
#control: pid
#pid_kp: 14.42
#pid_ki: 0.88
#pid_kd: 59.12
# Pressure Advance - zmierz ponownie po obniżeniu max_accel
pressure_advance: 0.06
pressure_advance_smooth_time: 0.040  # DODANE

# Heated Bed
[heater_bed]
heater_pin: PB9
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PC1
min_temp: 0
max_temp: 120
#control: pid
#pid_kp: 97.1
#pid_ki: 1.41
#pid_kd: 1675.16

# Probe Settings - Ulepszone
[probe]
pin: PA1
x_offset: 24.0
y_offset: 13.35
#z_offset: 0  # W SAVE_CONFIG: 1.441
samples: 3
samples_result: average
sample_retract_dist: 2
speed: 10  # ZMIENIONE: Wolniejsze = dokładniejsze
lift_speed: 8
samples_tolerance: 0.05  # ZMIENIONE: Bardziej rygorystyczne
samples_tolerance_retries: 5  # ZWIĘKSZONE

# NOWE: Wyrównanie śrub łóżka (pomaga z nierównością)
[screws_tilt_adjust]
screw1: -10, -2
screw1_name: Przedni lewy
screw2: 186, -2
screw2_name: Przedni prawy
screw3: 186, 202
screw3_name: Tylny prawy
screw4: -10, 202
screw4_name: Tylny lewy
horizontal_move_z: 5
speed: 200
screw_thread: CCW-M4  # Dostosuj do swojej drukarki

# Bed Mesh - Rozszerzona siatka
[bed_mesh]
speed: 150  # ZMIENIONE: Wolniejsze dla dokładności
horizontal_move_z: 3
mesh_min: 14, 11
mesh_max: 210, 215
probe_count: 9, 9  # ZWIĘKSZONE: 7x7 -> 9x9 dla lepszej dokładności
mesh_pps: 4, 4
algorithm: bicubic
bicubic_tension: 0.2
fade_start: 1.0  # DODANE: Stopniowe zanikanie kompensacji
fade_end: 10.0   # DODANE
fade_target: 0   # DODANE

# Safe Z Home
[safe_z_home]
home_xy_position: 110, 110
speed: 100
z_hop: 10
z_hop_speed: 15
move_to_previous: False  # DODANE

# Fans
[controller_fan controller_fan]
pin: PB12
stepper: stepper_x, stepper_y, stepper_z, extruder  # DODANE: Precyzyjne sterowanie
idle_timeout: 60  # DODANE: Wyłącz po 60s bezczynności

[heater_fan extruder_fan]
pin: PB13
heater: extruder  # DODANE: Jasne powiązanie
heater_temp: 50.0  # DODANE: Włącz powyżej 50°C
fan_speed: 1.0    # DODANE

[fan]
pin: PB5
cycle_time: 0.0001  # ZMIENIONE: 10kHz zamiast 20kHz (bardziej kompatybilne)
kick_start_time: 0.5  # DODANE: Pomaga przy starcie wentylatora

# Power Pin
[output_pin enable_pin]
pin: PB6
value: 1
shutdown_value: 1

# NOWE: Exclude Object (przydatne w Mainsail)
[exclude_object]

# NOWE: Arc Support (gładsze linie)
[gcode_arcs]
resolution: 0.1

[include moonraker_obico_macros.cfg]
# =============================================================================
# ZAAWANSOWANE ZMIENNE DLA MAIINSAIL/KLIPPER MACROS
# =============================================================================

[gcode_macro _CLIENT_VARIABLE]
variable_use_custom_pos   : True  ; Używamy własnych współrzędnych parkowania
variable_custom_park_x    : 110.0 ; Środek osi X dla Anycubic Kobra 2 Neo
variable_custom_park_y    : 10.0  ; Przód stołu (łatwy dostęp do nakładania cukru)
variable_custom_park_dz   : 10.0  ; Podnieś głowicę o 10mm przy pauzie
variable_retract          : 1.0   ; Cofnięcie filamentu przy pauzie (zapobiega wyciekom)
variable_cancel_retract   : 5.0   ; Mocniejsze cofnięcie przy anulowaniu druku
variable_speed_retract    : 35.0  ; Prędkość retrakcji (mm/s)
variable_unretract        : 1.0   ; Powrót filamentu przy wznowieniu
variable_speed_move       : 150.0 ; Prędkość przejazdów (zgodnie z Twoim limitem)
variable_park_at_cancel   : True  ; Głowica odjedzie po anulowaniu druku
gcode:

# =============================================================================
# PODSTAWOWE MODUŁY KLIENTA (BEZ DUPLIKATÓW)
# =============================================================================

[virtual_sdcard]
path: ~/printer_data/gcodes
on_error_gcode: CANCEL_PRINT

[display_status]

[pause_resume]

[respond] # Wymagane dla komunikatów tekstowych w konsoli

# UWAGA: Makra PAUSE, RESUME i CANCEL_PRINT znajdują się 
# w pliku pause_resume.cfg, który masz już w folderze config.

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [probe]
#*# z_offset = 1.576
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 18.431
#*# pid_ki = 0.740
#*# pid_kd = 114.732
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 60.459
#*# pid_ki = 0.960
#*# pid_kd = 952.231
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  0.224167, 0.219167, 0.272500, 0.367500, 0.397500, 0.467500, 0.574167, 0.670000, 0.790833
#*# 	  0.090000, 0.097500, 0.146667, 0.253333, 0.298333, 0.357500, 0.470833, 0.563333, 0.684167
#*# 	  0.025000, 0.032500, 0.090833, 0.195000, 0.247500, 0.310833, 0.409167, 0.516667, 0.628333
#*# 	  -0.033333, -0.019167, 0.032500, 0.139167, 0.176667, 0.239167, 0.340833, 0.433333, 0.530833
#*# 	  -0.118333, -0.125000, -0.076667, 0.012500, 0.045000, 0.088333, 0.201667, 0.290833, 0.322500
#*# 	  -0.165833, -0.191667, -0.167500, -0.076667, -0.035833, -0.037500, 0.035000, 0.089167, 0.104167
#*# 	  -0.255000, -0.300833, -0.298333, -0.223333, -0.196667, -0.216667, -0.189167, -0.166667, -0.146667
#*# 	  -0.417500, -0.477500, -0.490000, -0.438333, -0.436667, -0.435000, -0.396667, -0.394167, -0.400000
#*# 	  -0.579167, -0.649167, -0.676667, -0.636667, -0.641667, -0.640000, -0.609167, -0.605000, -0.607500
#*# x_count = 9
#*# y_count = 9
#*# mesh_x_pps = 4
#*# mesh_y_pps = 4
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 14.0
#*# max_x = 210.0
#*# min_y = 11.0
#*# max_y = 215.0
